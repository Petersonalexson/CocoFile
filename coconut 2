Sub RefreshSmartViewTree()

    Dim arrSheets As Variant
    Dim wsLists As Worksheet
    Dim ws As Worksheet
    Dim ConnectionName As String
    Dim Ret As Long, HeaderRow As Long, LastRow As Long, i As Long
    Dim ConnStatus As Integer
    
    ' Change "wsLists" to the sheet that contains nmConnectionName & Hierarchy_Matrix
    Set wsLists = ThisWorkbook.Worksheets("Lists")  
    
    With wsLists
        ConnectionName = .Range("nmConnectionName").Value
        arrSheets = .Range("Hierarchy_Matrix").Value
    End With

    HeaderRow = 4
    
    For i = LBound(arrSheets, 1) To UBound(arrSheets, 1)
        
        ' 1) Grab the worksheet
        Set ws = ThisWorkbook.Worksheets(arrSheets(i, 1))
        
        With ws
            ' 2) Connect to Smart View
            Ret = HypUIConnect(.Name, "", "", ConnectionName)
            ConnStatus = HypConnected(.Name)
            If ConnStatus <> -1 Then Stop  ' Debug check if not connected
            
            ' 3) Calculate the last row in Column A
            LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
            
            ' 4) Delete hierarchy rows except the "hierarchy name" in the last row
            If LastRow > HeaderRow Then
                .Rows(HeaderRow & ":" & (LastRow - 1)).Delete Shift:=xlUp
            End If
            
            LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
            
            ' 5) Set the member display option
            Ret = HypSetSheetOption(.Name, HYP_SVC_OPTIONS_INDEX.HSV_MEMBER_DISPLAY, 1)
            
            ' 6) Drill (Zoom In) on the bottom cell
            Ret = HypZoomIn(.Name, .Range("A" & LastRow), 1, False)
            
            ' 7) Recalculate last row after zoom
            LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
            
            ' ------------------------------------------------------------
            ' 8) RESET the named range so it covers the new data
            '    arrSheets(i, 2) = Name of the range (e.g. "MyHierarchyRange")
            ' ------------------------------------------------------------
            ThisWorkbook.Names(arrSheets(i, 2)).RefersTo = _
                "='" & .Name & "'!A" & (HeaderRow + 1) & ":A" & LastRow
        End With
        
        Set ws = Nothing
    Next i
    
    MsgBox "Smart View tree refresh complete!", vbInformation
End Sub
