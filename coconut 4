Sub CreateQueryTablesFromHierarchies()
    Dim arrSheets As Variant
    Dim i As Long
    Dim rangeName As String
    Dim queryName As String
    Dim sheetName As String
    Dim querySheet As Worksheet
    Dim queryText As String
    
    ' Get the hierarchy matrix
    With wsLists
        arrSheets = .Range("Hierarchy_Matrix")
    End With
    
    ' Turn off screen updating for better performance
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    
    ' Loop through each hierarchy
    For i = LBound(arrSheets) To UBound(arrSheets)
        rangeName = Trim(arrSheets(i, 2))
        sheetName = Trim(arrSheets(i, 1))
        queryName = sheetName & "_Table"
        
        ' Check if the worksheet exists
        On Error Resume Next
        Set querySheet = ThisWorkbook.Worksheets(queryName)
        On Error GoTo 0
        
        If querySheet Is Nothing Then
            ' Create a new sheet for the query table
            Set querySheet = ThisWorkbook.Sheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count))
            querySheet.Name = queryName
        Else
            ' Clear existing content
            querySheet.UsedRange.Clear
        End If
        
        ' Build the Power Query M code
        queryText = BuildQueryText(rangeName)
        
        ' Use a more direct approach to create the query
        Dim queryDef As Object
        
        ' First, remove any existing connection with this name
        On Error Resume Next
        For Each Connection In ThisWorkbook.Connections
            If Connection.Name = queryName Then
                Connection.Delete
                Exit For
            End If
        Next Connection
        On Error GoTo 0
        
        ' Create the Power Query using the Excel Object Model
        On Error Resume Next
        
        ' Create a connection to the workbook data
        Dim wb As Workbook
        Set wb = ThisWorkbook
        
        ' Create a new Power Query connection
        Dim scriptConnection As WorkbookConnection
        Set scriptConnection = wb.Queries.Add(queryName, queryText)
        
        ' Create a query table on the worksheet
        Set queryDef = querySheet.ListObjects.Add(SourceType:=xlSrcExternal, _
                                                Source:=Array("OLEDB;Provider=Microsoft.Mashup.OleDb.1;Data Source=$Workbook$;Location=" & queryName), _
                                                Destination:=querySheet.Range("A1"))
        
        ' Link the query to the table
        queryDef.QueryTable.CommandType = xlCmdSql
        queryDef.QueryTable.CommandText = Array(queryName)
        queryDef.QueryTable.Refresh BackgroundQuery:=False
        
        If Err.Number <> 0 Then
            MsgBox "Error creating query for " & sheetName & ": " & Err.Description, vbExclamation
        End If
        On Error GoTo 0
        
        ' Auto-fit columns
        querySheet.Columns("A:Z").AutoFit
    Next i
    
    ' Turn screen updating back on
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
    
    MsgBox "Query tables created/updated successfully for all hierarchies!", vbInformation, "Process Complete"
End Sub
